<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>하드자막 OCR 추출기</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
  <div class="container">
    <h1>MP4 하드자막 OCR 추출기</h1>

    {% if job and job.error %}
    <section class="card">
      <p class="error">{{ job.error }}</p>
    </section>
    {% endif %}

    <section class="card">
      <h2>1) 영상 업로드</h2>
      <form action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data">
        <input type="file" name="video" accept="video/mp4" required />
        <button type="submit">업로드</button>
      </form>
    </section>

    {% if job %}
    <section class="card">
      <h2>2) 자막이 보이는 프레임 선택</h2>
      {% if job.thumbnails %}
      <form action="{{ url_for('select_frame') }}" method="post">
        <input type="hidden" name="job_id" value="{{ job_id }}" />
        <div class="thumb-grid">
          {% for thumb in job.thumbnails %}
          <label class="thumb-item">
            <input type="radio" name="timestamp" value="{{ thumb.timestamp }}" required
              {% if job.selected_timestamp == thumb.timestamp %}checked{% endif %} />
            <img src="/{{ thumb.path }}" alt="{{ thumb.timestamp }}s" />
            <span>{{ thumb.timestamp }}s</span>
          </label>
          {% endfor %}
        </div>
        <button type="submit">이 프레임 선택</button>
      </form>
      {% endif %}
    </section>
    {% endif %}

    {% if job and job.selected_frame %}
    <section class="card">
      <h2>3) ROI(자막 영역) 드래그 지정</h2>
      <p>이미지를 드래그해 ROI를 만들고, 박스를 이동/리사이즈하거나 숫자로 미세 조정하세요.</p>
      <div class="frame-stage">
        <div class="frame-wrap">
          <img id="roi-image" src="/{{ job.selected_frame }}" alt="선택 프레임" />
          <div id="roi-box">
            <span class="roi-handle roi-handle-nw" data-handle="nw"></span>
            <span class="roi-handle roi-handle-ne" data-handle="ne"></span>
            <span class="roi-handle roi-handle-sw" data-handle="sw"></span>
            <span class="roi-handle roi-handle-se" data-handle="se"></span>
            <span class="roi-handle roi-handle-n" data-handle="n"></span>
            <span class="roi-handle roi-handle-s" data-handle="s"></span>
            <span class="roi-handle roi-handle-w" data-handle="w"></span>
            <span class="roi-handle roi-handle-e" data-handle="e"></span>
          </div>
        </div>
      </div>
      <form action="{{ url_for('set_roi') }}" method="post" id="roi-form">
        <input type="hidden" name="job_id" value="{{ job_id }}" />
        <input type="hidden" name="x" id="x" value="{{ job.roi.x if job.roi else '' }}" />
        <input type="hidden" name="y" id="y" value="{{ job.roi.y if job.roi else '' }}" />
        <input type="hidden" name="w" id="w" value="{{ job.roi.w if job.roi else '' }}" />
        <input type="hidden" name="h" id="h" value="{{ job.roi.h if job.roi else '' }}" />

        <div class="roi-controls">
          <label>x <input type="number" id="roi-x" min="0" step="1" value="{{ job.roi.x if job.roi else 0 }}" /></label>
          <label>y <input type="number" id="roi-y" min="0" step="1" value="{{ job.roi.y if job.roi else 0 }}" /></label>
          <label>w <input type="number" id="roi-w" min="1" step="1" value="{{ job.roi.w if job.roi else 0 }}" /></label>
          <label>h <input type="number" id="roi-h" min="1" step="1" value="{{ job.roi.h if job.roi else 0 }}" /></label>
          <button type="button" id="roi-reset" class="secondary">ROI 초기화</button>
        </div>

        <button type="submit">ROI 저장</button>
      </form>
      {% if job.roi %}
      <p class="success">현재 ROI: x={{ job.roi.x }}, y={{ job.roi.y }}, w={{ job.roi.w }}, h={{ job.roi.h }}</p>
      <form action="{{ url_for('start_ocr') }}" method="post">
        <input type="hidden" name="job_id" value="{{ job_id }}" />
        <label>
          <input type="checkbox" name="limit_to_60" checked />
          60초까지만 OCR (기본값)
        </label>
        <button type="submit">2초 간격 OCR 시작</button>
      </form>
      {% endif %}
    </section>
    {% endif %}

    {% if job and job.status == 'processing' %}
    <section class="card processing">
      <h2>OCR 처리 중...</h2>
      <p>2초마다 ROI를 OCR 중입니다. 잠시만 기다려주세요.</p>
      <p>진행 상황: {{ job.progress_current or 0 }}/{{ job.progress_total or 0 }} frames</p>
      {% if config.DEBUG and job.debug_preprocessed_roi %}
      <p>디버그 전처리 ROI 미리보기</p>
      <img src="/{{ job.debug_preprocessed_roi }}" alt="전처리 ROI 디버그" />
      {% endif %}
      <form action="{{ url_for('reset_roi') }}" method="post">
        <input type="hidden" name="job_id" value="{{ job_id }}" />
        <button type="submit" class="secondary">ROI 재설정</button>
      </form>
    </section>
    <meta http-equiv="refresh" content="2">
    {% endif %}

    {% if job and job.status == 'done' %}
    <section class="card">
      <h2>OCR 결과 (중복/유사 문장 제거)</h2>
      {% if config.DEBUG and job.debug_preprocessed_roi %}
      <p>디버그 전처리 ROI 미리보기</p>
      <img src="/{{ job.debug_preprocessed_roi }}" alt="전처리 ROI 디버그" />
      {% endif %}
      <pre class="result">{{ job.result_text }}</pre>
      <a class="button" href="{{ url_for('download', job_id=job_id) }}">TXT 다운로드</a>
      <form action="{{ url_for('reset_roi') }}" method="post" class="inline-form">
        <input type="hidden" name="job_id" value="{{ job_id }}" />
        <button type="submit" class="secondary">ROI 재설정</button>
      </form>
    </section>
    {% endif %}

    {% if job and job.status == 'cancelled' %}
    <section class="card">
      <h2>OCR 취소됨</h2>
      <p>ROI를 다시 지정한 뒤 OCR을 재시작하세요.</p>
    </section>
    {% endif %}
  </div>

  <script src="{{ url_for('static', filename='app.js') }}"></script>
  <script>
    const roiForm = document.getElementById("roi-form");
    if (roiForm) {
      roiForm.addEventListener("submit", (e) => {
        const w = document.getElementById("w")?.value;
        const h = document.getElementById("h")?.value;
        if (!w || !h || Number(w) <= 0 || Number(h) <= 0) {
          e.preventDefault();
          alert("ROI를 드래그로 지정하세요");
        }
      });
    }
  </script>
</body>
</html>
